{"Resources": {"FirehoseRoleAA67C190": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Statement": [{"Action": "sts:AssumeRole", "Effect": "Allow", "Principal": {"Service": "firehose.amazonaws.com"}}], "Version": "2012-10-17"}}, "Metadata": {"aws:cdk:path": "IotPipelineStack/FirehoseRole/Resource"}}, "FirehoseRoleDefaultPolicyF034DFF7": {"Type": "AWS::IAM::Policy", "Properties": {"PolicyDocument": {"Statement": [{"Action": ["s3:GetObject*", "s3:GetBucket*", "s3:List*", "s3:DeleteObject*", "s3:PutObject", "s3:PutObjectLegalHold", "s3:PutObjectRetention", "s3:PutObjectTagging", "s3:PutObjectVersionTagging", "s3:Abort*"], "Effect": "Allow", "Resource": [{"Fn::Join": ["", ["arn:", {"Ref": "AWS::Partition"}, ":s3:::iot-analytics-datalake"]]}, {"Fn::Join": ["", ["arn:", {"Ref": "AWS::Partition"}, ":s3:::iot-analytics-datalake/*"]]}]}, {"Action": ["logs:PutLogEvents", "logs:CreateLogStream", "logs:CreateLogGroup"], "Effect": "Allow", "Resource": "arn:aws:logs:*:*:log-group:/aws/kinesisfirehose/*:log-stream:*"}], "Version": "2012-10-17"}, "PolicyName": "FirehoseRoleDefaultPolicyF034DFF7", "Roles": [{"Ref": "FirehoseRoleAA67C190"}]}, "Metadata": {"aws:cdk:path": "IotPipelineStack/FirehoseRole/DefaultPolicy/Resource"}}, "IoTDataFirehose": {"Type": "AWS::KinesisFirehose::DeliveryStream", "Properties": {"DeliveryStreamType": "DirectPut", "S3DestinationConfiguration": {"BucketARN": {"Fn::Join": ["", ["arn:", {"Ref": "AWS::Partition"}, ":s3:::iot-analytics-datalake"]]}, "BufferingHints": {"IntervalInSeconds": 60, "SizeInMBs": 5}, "CloudWatchLoggingOptions": {"Enabled": true, "LogGroupName": "/aws/kinesisfirehose/iot-delivery-stream", "LogStreamName": "s3-delivery"}, "CompressionFormat": "UNCOMPRESSED", "ErrorOutputPrefix": "iot-errors/!{firehose:error-output-type}/", "Prefix": "iot-data/year=!{timestamp:yyyy}/month=!{timestamp:MM}/day=!{timestamp:dd}/", "RoleARN": {"Fn::GetAtt": ["FirehoseRoleAA67C190", "Arn"]}}}, "Metadata": {"aws:cdk:path": "IotPipelineStack/IoTDataFirehose"}}, "SensorStream4732CA3B": {"Type": "AWS::Kinesis::Stream", "Properties": {"RetentionPeriodHours": 24, "ShardCount": 1, "StreamEncryption": {"EncryptionType": "KMS", "KeyId": "alias/aws/kinesis"}}, "UpdateReplacePolicy": "Retain", "DeletionPolicy": "Retain", "Metadata": {"aws:cdk:path": "IotPipelineStack/SensorStream/Resource"}}, "IoTRuleKinesisRole99673486": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Statement": [{"Action": "sts:AssumeRole", "Effect": "Allow", "Principal": {"Service": "iot.amazonaws.com"}}], "Version": "2012-10-17"}}, "Metadata": {"aws:cdk:path": "IotPipelineStack/IoTRuleKinesisRole/Resource"}}, "IoTRuleKinesisRoleDefaultPolicy43060F55": {"Type": "AWS::IAM::Policy", "Properties": {"PolicyDocument": {"Statement": [{"Action": ["kinesis:ListShards", "kinesis:PutRecord", "kinesis:PutRecords"], "Effect": "Allow", "Resource": {"Fn::GetAtt": ["SensorStream4732CA3B", "Arn"]}}], "Version": "2012-10-17"}, "PolicyName": "IoTRuleKinesisRoleDefaultPolicy43060F55", "Roles": [{"Ref": "IoTRuleKinesisRole99673486"}]}, "Metadata": {"aws:cdk:path": "IotPipelineStack/IoTRuleKinesisRole/DefaultPolicy/Resource"}}, "SensorRule": {"Type": "AWS::IoT::TopicRule", "Properties": {"TopicRulePayload": {"Actions": [{"Kinesis": {"PartitionKey": "${timestamp()}", "RoleArn": {"Fn::GetAtt": ["IoTRuleKinesisRole99673486", "Arn"]}, "StreamName": {"Ref": "SensorStream4732CA3B"}}}], "AwsIotSqlVersion": "2016-03-23", "RuleDisabled": false, "Sql": "SELECT * FROM 'factory/+/sensors'"}}, "Metadata": {"aws:cdk:path": "IotPipelineStack/SensorRule"}}, "StreamProcessorServiceRole38F6612A": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Statement": [{"Action": "sts:AssumeRole", "Effect": "Allow", "Principal": {"Service": "lambda.amazonaws.com"}}], "Version": "2012-10-17"}, "ManagedPolicyArns": [{"Fn::Join": ["", ["arn:", {"Ref": "AWS::Partition"}, ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]]}]}, "Metadata": {"aws:cdk:path": "IotPipelineStack/StreamProcessor/ServiceRole/Resource"}}, "StreamProcessorServiceRoleDefaultPolicy25F89E31": {"Type": "AWS::IAM::Policy", "Properties": {"PolicyDocument": {"Statement": [{"Action": ["kinesis:DescribeStreamSummary", "kinesis:GetRecords", "kinesis:GetShardIterator", "kinesis:ListShards", "kinesis:SubscribeToShard", "kinesis:DescribeStream", "kinesis:ListStreams", "kinesis:DescribeStreamConsumer"], "Effect": "Allow", "Resource": {"Fn::GetAtt": ["SensorStream4732CA3B", "Arn"]}}, {"Action": ["firehose:PutRecord", "firehose:PutRecordBatch"], "Effect": "Allow", "Resource": {"Fn::GetAtt": ["IoTDataFirehose", "Arn"]}}], "Version": "2012-10-17"}, "PolicyName": "StreamProcessorServiceRoleDefaultPolicy25F89E31", "Roles": [{"Ref": "StreamProcessorServiceRole38F6612A"}]}, "Metadata": {"aws:cdk:path": "IotPipelineStack/StreamProcessor/ServiceRole/DefaultPolicy/Resource"}}, "StreamProcessorA985C501": {"Type": "AWS::Lambda::Function", "Properties": {"Code": {"S3Bucket": {"Fn::Sub": "cdk-myuniq123-assets-${AWS::AccountId}-${AWS::Region}"}, "S3Key": "41189ac6280630573e5bcca10736f463cda6ec864277a22b9b692f3ef91309ff.zip"}, "Environment": {"Variables": {"FIREHOSE_NAME": {"Ref": "IoTDataFirehose"}, "S3_BUCKET_NAME": "iot-analytics-datalake"}}, "Handler": "processor.lambda_handler", "Role": {"Fn::GetAtt": ["StreamProcessorServiceRole38F6612A", "Arn"]}, "Runtime": "python3.9", "Timeout": 30}, "DependsOn": ["StreamProcessorServiceRoleDefaultPolicy25F89E31", "StreamProcessorServiceRole38F6612A"], "Metadata": {"aws:cdk:path": "IotPipelineStack/StreamProcessor/Resource", "aws:asset:path": "asset.41189ac6280630573e5bcca10736f463cda6ec864277a22b9b692f3ef91309ff", "aws:asset:is-bundled": false, "aws:asset:property": "Code"}}, "CDKMetadata": {"Type": "AWS::CDK::Metadata", "Properties": {"Analytics": "v2:deflate64:H4sIAAAAAAAA/zWNwW7CMBBEv4X7ZguJOPRYUnFtlXBHxtnQJY6NvGsQivLvlRNxmvekGU2Ju889bjfmKYXthsLxBadWjR3APOU8SYWHZAfSgxECNiNOTXAEde+X/A2O7SvrSjMM7ElYeo70F4Sw7v03OX5QfLUayYzvRv5ZvO79SjNw0Dw4hTvbJjkCZ8ZLZ3A6Jm+Vg8/lN88g1dmIkAp+5ZihIQkpWoLFWzVX9te8+Ul6TzqDDx3hTT4eZYm7CrebmzAXMXnlkbBZ8x9YYOIeFQEAAA=="}, "Metadata": {"aws:cdk:path": "IotPipelineStack/CDKMetadata/Default"}, "Condition": "CDKMetadataAvailable"}}, "Outputs": {"FirehoseStreamArn": {"Value": {"Fn::GetAtt": ["IoTDataFirehose", "Arn"]}}, "KinesisStreamArn": {"Value": {"Fn::GetAtt": ["SensorStream4732CA3B", "Arn"]}}}, "Conditions": {"CDKMetadataAvailable": {"Fn::Or": [{"Fn::Or": [{"Fn::Equals": [{"Ref": "AWS::Region"}, "af-south-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "ap-east-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "ap-northeast-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "ap-northeast-2"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "ap-northeast-3"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "ap-south-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "ap-south-2"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "ap-southeast-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "ap-southeast-2"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "ap-southeast-3"]}]}, {"Fn::Or": [{"Fn::Equals": [{"Ref": "AWS::Region"}, "ap-southeast-4"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "ca-central-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "ca-west-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "cn-north-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "cn-northwest-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "eu-central-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "eu-central-2"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "eu-north-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "eu-south-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "eu-south-2"]}]}, {"Fn::Or": [{"Fn::Equals": [{"Ref": "AWS::Region"}, "eu-west-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "eu-west-2"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "eu-west-3"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "il-central-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "me-central-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "me-south-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "sa-east-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "us-east-1"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "us-east-2"]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "us-west-1"]}]}, {"Fn::Equals": [{"Ref": "AWS::Region"}, "us-west-2"]}]}}, "Parameters": {"BootstrapVersion": {"Type": "AWS::SSM::Parameter::Value<String>", "Default": "/cdk-bootstrap/myuniq123/version", "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"}}, "Rules": {"CheckBootstrapVersion": {"Assertions": [{"Assert": {"Fn::Not": [{"Fn::Contains": [["1", "2", "3", "4", "5"], {"Ref": "BootstrapVersion"}]}]}, "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."}]}}}